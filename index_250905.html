<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Avisv√¶rksted ‚Äì Elevudgave V6 (Research‚ÜíUdkast ‚Ä¢ Skriv side‚Äëom‚Äëside)</title>
<style>
  :root{ --ink:#253044; --muted:#7a879a; --bg:#f7f9fc; --paper:#ffffff; --line:#e8edf3; --accent:#e58a7d; --accent-2:#7c91e6; --ok:#2e7d32; --warn:#cf6a2a; --shadow:0 8px 24px rgba(21,37,72,.06); }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);
    background:radial-gradient(1200px 500px at 10% -20%,#eef3fb 0%,transparent 60%),radial-gradient(900px 400px at 90% -10%,#fdf1ee 0%,transparent 55%),var(--bg)}
  .top{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.85);backdrop-filter:blur(6px);border-bottom:1px solid var(--line)}
  .wrap{max-width:1100px;margin:0 auto;padding:14px 18px}
  .brand{display:flex;align-items:center;gap:12px;justify-content:space-between}
  .brand-left{display:flex;align-items:center;gap:12px}
  .logo{font-weight:800;letter-spacing:.2px;font-size:clamp(22px,4vw,32px)}
  .badge{background:linear-gradient(135deg,#f8a46b,#ec7d55);color:#fff;padding:4px 10px;border-radius:10px;font-weight:700;font-size:12px;box-shadow:var(--shadow)}
  .brand-right{display:flex;align-items:center;gap:8px}
  .btn{appearance:none;border:1px solid var(--line);background:#fff;color:var(--ink);padding:10px 14px;border-radius:14px;font-weight:800;cursor:pointer;box-shadow:0 1px 0 rgba(0,0,0,.02)}
  .btn.primary{background:var(--accent);color:#fff;border:none;box-shadow:0 6px 16px rgba(236,132,109,.25)}
  .btn.alt{background:var(--accent-2);color:#fff;border:none;box-shadow:0 6px 16px rgba(124,145,230,.25)}
  .btn.ghost{background:#fff}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .icon{width:22px;height:22px;display:inline-grid;place-items:center}

  .stepper{display:flex;gap:14px;align-items:center;overflow-x:auto;padding:10px 0}
  .step{position:relative;display:flex;align-items:center;gap:10px;padding:12px 14px 24px;border-radius:16px;font-weight:700;white-space:nowrap;cursor:pointer;background:linear-gradient(180deg,#fff,#fafcfe);border:1px solid var(--line)}
  .step.active{border-color:var(--accent);box-shadow:0 0 0 4px rgba(229,138,125,.16)}
  .step.completed{border-color:#bfe3c2;background:linear-gradient(180deg,#ffffff,#f7fbf8)}
  .step::after{content:"";position:absolute;left:16px;right:16px;bottom:6px;height:6px;border-radius:999px;background:#eaeef7}
  .step[data-step="s1"]::after{background:#f6c3b4}
  .step[data-step="s2"]::after{background:#bdc9fb}
  .step[data-step="s3"]::after{background:#c5ecd3}
  .step[data-step="s4"]::after{background:#fbe7a2}

  main{max-width:1100px;margin:18px auto 28px;padding:0 18px}
  .panel{background:var(--paper);border:1px solid var(--line);border-radius:18px;padding:18px;box-shadow:var(--shadow)}
  .panel h2{margin:0 0 6px;font-size:clamp(18px,2.6vw,26px)}
  .sub{color:var(--muted);margin:0 0 12px;font-size:14px}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:1000px){.grid{grid-template-columns:1.1fr .9fr}}
  label{font-weight:800;display:block;margin:6px 0}
  .field{display:flex;gap:10px;align-items:center}
  input[type=text],textarea,select{flex:1;width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:14px;font:inherit;background:#fff}
  textarea{min-height:120px}
  .help{background:#fff8e7;border:1px solid #ffe1b3;border-radius:12px;padding:12px;font-size:14px}
  .hint{font-size:13px;color:var(--muted)}
  .output{white-space:pre-wrap;background:#f0f5ff;border:1px dashed #cbd5e1;padding:12px;border-radius:10px;min-height:60px}
  .ideas{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px}
  .ideas h3{margin:0 0 6px;font-size:16px}
  .ideas ul{list-style:none;margin:0;padding:0}
  .ideas li{padding:8px 10px;border:1px solid var(--line);border-radius:10px;margin-bottom:6px;cursor:pointer}
  .ideas li:hover{box-shadow:var(--shadow)}
  .list{list-style:none;margin:6px 0 0;padding:0}
  .list li{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);border-radius:10px;padding:8px 10px;margin-bottom:6px}

  .split{display:grid;gap:16px}
  @media(min-width:1000px){.split{grid-template-columns:1fr 1fr}}
  .card{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff}
  .slider-row{display:flex;align-items:center;gap:10px}
  input[type=range]{width:100%}

  @media print{ header,.no-print{display:none!important} .print-only{display:block} }
  .print-only{display:none}
</style>
</head>
<body>
  <header class="top">
    <div class="wrap">
      <div class="brand">
        <div class="brand-left">
          <div class="logo">AVISV√ÜRKSTEDET</div>
          <div class="badge">ELEVUDGAVE</div>
        </div>
        <div class="brand-right">
          <button class="btn" id="saveBtn" title="Gem i denne browser">üíæ Gem kladde</button>
          <button class="btn" id="settingsBtn" title="Indstillinger" style="display:none">‚öôÔ∏è Indstillinger</button>
        </div>
      </div>
      <nav class="stepper" id="stepper">
        <div class="step active" data-step="s1"><span class="icon">üí°</span><span>Id√©</span></div>
        <div class="step" data-step="s2"><span class="icon">üîé</span><span>Research</span></div>
        <div class="step" data-step="s3"><span class="icon">‚úçÔ∏è</span><span>Skriv</span></div>
        <div class="step" data-step="s4"><span class="icon">üì∞</span><span>Avisside</span></div>
      </nav>
    </div>
  </header>

  <main class="no-print">
    <!-- S1: Id√© -->
    <section id="s1" class="panel">
      <h2>Fase 1 ¬∑ Id√© & vinkel</h2>
      <p class="sub">Find f√∏rst emne og vinkel. Lav derefter arbejdsark til research.</p>
      <div class="grid">
        <div>
          <label>Artikeltype</label>
          <select id="type">
            <option value="nyhed">Nyhed</option>
            <option value="reportage">Reportage</option>
            <option value="interview">Interview</option>
            <option value="feature">Feature</option>
            <option value="debat">Holdningsindl√¶g</option>
            <option value="ugen-der-gik">AVIS: Ugen der gik</option>
            <option value="naeste-uge">AVIS: N√¶ste uge</option>
          </select>

          <label>Emne</label>
          <div class="field">
            <input id="idea" type="text" placeholder="Fx: Kantinen skifter menu" />
          </div>

          <label>Vinkel eller sp√∏rgsm√•l</label>
          <div class="field">
            <input id="angle" type="text" placeholder="Fx: Flere vegetarretter efter elev√∏nske" />
          </div>

          <div class="field" style="gap:8px;flex-wrap:wrap">
            <button class="btn" id="ideaHelp">üí° Id√©‚Äëhj√¶lp</button>
            <button class="btn" id="worksheet">üñ®Ô∏è Lav arbejdsark</button>
            <button class="btn primary" id="toS2">Videre til research</button>
          </div>
        </div>
        <aside>
          <div class="help">
            <strong>S√•dan arbejder vi:</strong>
            <ul style="margin:8px 0 0 18px;padding:0">
              <li>I finder id√© og vinkel</li>
              <li>I laver ALT research (interviews, fakta, citater)</li>
              <li>AI hj√¶lper kun med at formulere</li>
            </ul>
          </div>
        </aside>
      </div>
    </section>

    <!-- S2: Research ‚Äì identisk med arbejdsarkfelter -->
    <section id="s2" class="panel" style="display:none">
      <h2>Fase 2 ¬∑ Research</h2>
      <p class="sub">Skriv jeres noter her ‚Äì helt som i arbejdsarket. Vi laver et f√∏rste udkast af br√∏dteksten for jer.</p>
      <div class="grid">
        <div>
          <label>Fakta (hvad/hvor/hvorn√•r/hvem)</label>
          <textarea id="r_facts" placeholder="Datoer, tal, navne, beslutninger‚Ä¶ √©t pr. linje"></textarea>
          <label>Citater (ordret + navn/rolle)</label>
          <textarea id="r_quotes" placeholder='"Det her sagde personen" ‚Äì Navn, rolle'></textarea>
          <label>Observationer/detaljer</label>
          <textarea id="r_obs" placeholder="Stikord og indtryk‚Ä¶ √©t pr. linje"></textarea>
          <label>Billede‚Äëid√© (valgfri)</label>
          <input id="r_photo" type="text" placeholder="Fx: Drage i modlys over boldbanen">

          <div class="field" style="gap:8px;flex-wrap:wrap;margin-top:10px">
            <button class="btn alt" id="reopenWS">üìó √Öbn arbejdsark</button>
            <button class="btn primary" id="compileToDraft">Lav br√∏dtekst‚Äëafs√¶t</button>
            <button class="btn" id="toS3" disabled>Videre til skriv</button>
          </div>
        </div>
        <aside>
          <div class="help">
            Tip: Hold citater i "‚Ä¶". Vi √¶ndrer kun stavning/tegn i citater ‚Äì ikke indholdet.
          </div>
        </aside>
      </div>
    </section>

    <!-- S3: Skriv ‚Äì side‚Äëom‚Äëside med slider -->
    <section id="s3" class="panel" style="display:none">
      <h2>Fase 3 ¬∑ Skriv ‚Äì v√¶lg mellem din tekst og AI‚Äëforslag</h2>
      <div class="split">
        <div class="card">
          <h3 style="margin:0 0 6px">Din br√∏dtekst</h3>
          <textarea id="studentBody" placeholder="Din tekst‚Ä¶"></textarea>
          <div class="field" style="justify-content:flex-end;gap:8px;margin-top:8px">
            <button class="btn ghost" id="continueNoAI">Forts√¶t uden AI‚Äëhj√¶lp</button>
          </div>
        </div>
        <div class="card">
          <h3 style="margin:0 0 6px">AI‚Äëforslag</h3>
          <div class="slider-row">
            <span class="hint" style="min-width:80px">Hj√¶lp: </span>
            <input type="range" id="helpSlider" min="0" max="100" step="25" value="0"/>
            <span id="helpLabel" class="hint" style="min-width:100px;text-align:right">Fra</span>
          </div>
          <div class="hint" style="margin:6px 0 8px">Tr√¶k i skyderen for mere hj√¶lp. 0% = ingen, 100% = maks sprogl√∏ft + udvidelse. (K√∏rer uden n√∏gle: lokal sproghj√¶lp).</div>
          <div id="aiSuggestion" class="output" style="min-height:160px">(AI‚Äëforslag vises her)</div>
          <div class="field" style="justify-content:flex-end;gap:8px;margin-top:8px">
            <button class="btn" id="regen">Opdat√©r forslag</button>
            <button class="btn primary" id="adoptAI">Erstat min tekst med forslaget</button>
          </div>
        </div>
      </div>
    </section>

    <!-- S4: Avisside (rubrikforslag + k√∏ + printfix) -->
    <section id="s4" class="panel" style="display:none">
      <h2>Fase 4 ¬∑ Avisside</h2>
      <p class="sub">1) Redig√©r artikel ¬∑ 2) Tilf√∏j til avisside ¬∑ 3) Vis/Print</p>
      <div class="grid">
        <div>
          <label>Rubrik</label>
          <input id="headline" type="text" placeholder="Skriv/v√¶lg rubrik">
          <div class="ideas" style="margin:6px 0 10px">
            <h3>Rubrikforslag</h3>
            <ul id="headlineIdeas4"></ul>
          </div>
          <label>Underrubrik</label>
          <textarea id="sub" placeholder="Kort opsummering..." style="min-height:70px"></textarea>
          <label>Br√∏dtekst</label>
          <textarea id="body" placeholder="Redig√©r teksten s√• den bliver pr√¶cis som I vil have den" style="min-height:220px"></textarea>

          <label>Billeder (valgfrit)</label>
          <div class="help">
            <input type="file" id="imageUpload" accept="image/*" multiple>
            <div class="hint">JPG/PNG ¬∑ max 5 MB per billede</div>
            <div id="imgMsg" class="hint" style="display:none;color:var(--ok);margin-top:6px">Billede tilf√∏jet ‚úî</div>
          </div>
          <div id="imagePreview" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px"></div>

          <div class="field" style="gap:8px;flex-wrap:wrap;margin-top:10px">
            <button class="btn alt" id="addToPage">‚ûï Tilf√∏j denne artikel til avissiden</button>
            <button class="btn" id="viewPage">üì∞ Vis avisside</button>
            <button class="btn" id="clearPage">üßπ Ryd avisside</button>
            <button class="btn primary" id="print">üñ®Ô∏è Print/PDF</button>
          </div>
          <div class="hint" id="pageInfo"></div>
          <ul class="list" id="pageList"></ul>
        </div>
        <aside>
          <div id="ready" class="output"></div>
          <div class="hint" id="stats" style="margin-top:8px"></div>
        </aside>
      </div>
    </section>
  </main>

  <!-- Avisside til print (flere artikler) -->
  <div id="newspaper" class="print-only" style="display:none;margin:0 auto;max-width:900px;padding:12mm">
    <div style="border-bottom:3px double #000;padding-bottom:10px;margin-bottom:20px;text-align:center">
      <div style="font-size:28px;font-weight:800;letter-spacing:3px">SKOLE AVISEN</div>
      <div id="newsDate" style="font-size:13px;color:#555;margin-top:4px"></div>
    </div>
    <div id="newsContent"></div>
  </div>

  <!-- Indstillinger (API-n√∏gle) -->
  <dialog id="settingsDialog" style="border:1px solid var(--line);border-radius:14px;padding:16px;max-width:460px">
    <h3 style="margin:0 0 8px">Indstillinger</h3>
    <label>OpenAI API‚Äën√∏gle</label>
    <input type="text" id="apiKey" placeholder="sk-..." style="width:100%;padding:10px;border:1px solid var(--line);border-radius:10px">
    <p class="hint">N√∏glen gemmes kun i denne browser (localStorage). Bruges til AI‚Äëforslag i Skriv.</p>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button class="btn" id="closeSettings">Luk</button>
      <button class="btn primary" id="saveSettings">Gem</button>
    </div>
  </dialog>

  <div class="print-only" id="attribution" style="text-align:center;font-size:10px;color:#666;margin-top:6px"></div>
  <div id="toast" style="position:fixed;right:18px;bottom:18px;background:#2b6adf;color:#fff;padding:10px 14px;border-radius:12px;font-weight:700;box-shadow:var(--shadow);opacity:0;transform:translateY(10px);transition:.25s">Avisv√¶rksted indl√¶st ‚ú®</div>

<script>
(function(){
  const state = { current:'s1', data:{}, images:[], usedAI:false, lastWorksheet:null, pageArticles:[], apiKey:null };
  const $ = s=>document.querySelector(s); const $$ = s=>Array.from(document.querySelectorAll(s));
  const toastEl = $('#toast');
  function toast(msg){ toastEl.textContent=msg; toastEl.style.opacity=1; toastEl.style.transform='translateY(0)'; setTimeout(()=>{ toastEl.style.opacity=0; toastEl.style.transform='translateY(10px)'; }, 2000); }
  toast('Klar! Udfyld Id√© og Vinkel.');

  // --- Navigation ---
  function goTo(id){ ['s1','s2','s3','s4'].forEach(x=>$('#'+x).style.display = x===id?'block':'none');
    $$('#stepper .step').forEach(st=>{ const a = st.getAttribute('data-step')===id; st.classList.toggle('active',a); st.classList.toggle('completed', ['s1','s2','s3','s4'].indexOf(st.dataset.step) < ['s1','s2','s3','s4'].indexOf(id)); });
    state.current=id; window.scrollTo({top:0,behavior:'smooth'}); save(); if(id==='s4') makeHeadlineIdeas4(); }
  $$('#stepper .step').forEach(el=> el.addEventListener('click',()=> goTo(el.dataset.step)));
  $('#toS2').addEventListener('click', ()=>{ const idea=$('#idea').value.trim(), angle=$('#angle').value.trim(); if(!idea||!angle) return toast('Udfyld Id√© og Vinkel f√∏rst'); goTo('s2'); });

  // --- Save/Load ---
  function save(){ ['idea','angle','type','r_facts','r_quotes','r_obs','r_photo','headline','sub','body','studentBody'].forEach(id=>{ const el=$('#'+id); if(el) state.data[id]=el.value; }); localStorage.setItem('avis_v6', JSON.stringify(state)); }
  function load(){ try{ Object.assign(state, JSON.parse(localStorage.getItem('avis_v6'))||{}); }catch(e){}
    const d=state.data||{}; ['idea','angle','type','r_facts','r_quotes','r_obs','r_photo','headline','sub','body','studentBody'].forEach(id=>{ const el=$('#'+id); if(el && d[id]) el.value=d[id]; }); if(state.apiKey){ $('#apiKey').value=state.apiKey; } updatePageInfo(); renderPageList(); }
  $('#saveBtn').addEventListener('click', save);
  ['idea','angle','type','r_facts','r_quotes','r_obs','r_photo','headline','sub','body','studentBody'].forEach(id=> $('#'+id).addEventListener('input', save));

  // --- Settings ---
  const dlg=$('#settingsDialog'); $('#settingsBtn').addEventListener('click',()=> dlg.showModal());
  $('#closeSettings').addEventListener('click',()=> dlg.close());
  $('#saveSettings').addEventListener('click',()=>{ state.apiKey=$('#apiKey').value.trim()||null; save(); dlg.close(); toast(state.apiKey?'API‚Äën√∏gle gemt':'API‚Äën√∏gle fjernet'); });

  // --- Worksheet ---
  function openWorksheet(){ const idea=($('#idea').value||'Din artikel').toUpperCase(); const angle=$('#angle').value||'Din vinkel'; const type=$('#type').value;
    const html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>Arbejdsark</title><style>body{font-family:Arial,Helvetica,sans-serif;margin:15mm;line-height:1.5}h1{margin:0 0 6px}.hdr{border-bottom:2px solid #333;padding-bottom:8px;margin-bottom:12px}.sec{border:1px solid #ccc;padding:8px;margin:10px 0}.notes{min-height:40px;border-bottom:1px dotted #999;margin:4px 0}.small{font-size:12px;color:#666}</style></head><body>
    <div class="hdr"><h1>üì∞ ARBEJDSARK: ${idea}</h1><div class="small"><b>Type:</b> ${type} ¬∑ <b>Vinkel:</b> ${angle} ¬∑ Dato: ______ ¬∑ Reporter: __________</div></div>
    <div class="sec"><b>Plan (kilder & sp√∏rgsm√•l)</b><div class="notes"></div><div class="notes"></div></div>
    <div class="sec"><b>Fakta (hvad/hvor/hvorn√•r/hvem)</b><div class="notes"></div><div class="notes"></div></div>
    <div class="sec"><b>Citater (ordret + navn)</b><div class="notes"></div><div class="notes"></div></div>
    <div class="sec"><b>Observationer</b><div class="notes"></div></div>
    <div class="sec"><b>Tjek</b> ‚ñ° 2+ kilder ‚ñ° Fakta verificeret ‚ñ° Citater ordret ‚ñ° Navne korrekte</div></body></html>`;
    const w=open('','_blank'); if(w){ w.document.write(html); w.document.close(); state.lastWorksheet=html; save(); }
  }
  $('#worksheet').addEventListener('click', openWorksheet);
  $('#reopenWS').addEventListener('click', ()=>{ if(state.lastWorksheet){ const w=open('','_blank'); w.document.write(state.lastWorksheet); w.document.close(); } else toast('Lav f√∏rst et arbejdsark i Fase 1'); });

  // --- Compile Research ‚Üí Draft ---
  function createDraftFromResearch(){
    const type=$('#type').value, idea=$('#idea').value.trim(), angle=$('#angle').value.trim();
    const facts=($('#r_facts').value||'').trim().split(/\n+/).filter(Boolean);
    const quotes=($('#r_quotes').value||'').trim().split(/\n+/).filter(Boolean);
    const obs=($('#r_obs').value||'').trim().split(/\n+/).filter(Boolean);
    let a='';
    if(type==='ugen-der-gik'){ a += `Ugen der gik b√∏d p√• ${idea||'flere begivenheder'}. ${angle? angle+'. ':''}\n\n`; }
    else if(type==='naeste-uge'){ a += `${angle||idea||'Kommende begivenheder'}\n\n`; }
    else { a += `${angle||idea||''}\n\n`; }
    if(facts.length) a += facts.map(x=>x.replace(/\s+/g,' ').replace(/\.$/,'')).join('. ') + '.\n\n';
    if(quotes.length) a += quotes.map(line=>{ let t=line.trim(); if(!/^"/.test(t)) t='"'+t; if(!/[.!?]"?$/.test(t)) t=t.replace(/"?$/,',$&'); return t; }).join('\n\n') + '\n\n';
    if(obs.length) a += obs.map(x=>x.replace(/\s+/g,' ').replace(/\.$/,'')+'.').join(' ') + '\n\n';
    if(type==='ugen-der-gik') a+='Det var ugen der gik.';
    return a.replace(/\n\n\n+/g,'\n\n').trim();
  }

  $('#compileToDraft').addEventListener('click', ()=>{
    const draft = createDraftFromResearch();
    if(!draft){ toast('Skriv lidt i researchfelterne f√∏rst'); return; }
    $('#studentBody').value = draft; state.data.studentBody=draft; save(); toast('Udkast lavet ‚Äì g√• videre til Skriv'); $('#toS3').disabled=false; });
  $('#toS3').addEventListener('click', ()=> goTo('s3'));

  // --- Skriv: Slider‚Äëstyret AI‚Äëforslag ---
  const slider=$('#helpSlider'); const helpLabel=$('#helpLabel'); const aiBox=$('#aiSuggestion');
  function levelLabel(v){ return ({0:'Fra',25:'Lidt',50:'Mellem',75:'Meget',100:'Maks'})[v]||'Fra'; }
  slider.addEventListener('input', ()=>{ helpLabel.textContent=levelLabel(+slider.value); });

  function normalize(t){ return (t||'').replace(/\r/g,'').replace(/\s+/g,' ').replace(/\s([,.;:!?])/g,'$1').replace(/\s+‚Äî\s+/g,' ‚Äì ').trim(); }
  function ensureP(s){ return /[.!?]$/.test(s)?s:s+'.'; }

  function localLift(text, level){
    // Split citater ud
    const parts=text.split(/("[^"]+"|‚Äú[^‚Äù]+‚Äù)/).map(x=>({isQuote:/^"|‚Äú/.test(x),val:x}));
    const base=[[/ mega /gi,' meget '],[/ nice /gi,' godt '],[/ vildt /gi,' meget '],[/ ik\b/gi,' ikke']];
    const more=[[/\bman\b/gi,'eleverne']];
    function expand(s){ const bits=s.split(/\n|¬∑|‚Ä¢|\u2022|;|, /).map(v=>v.trim()).filter(Boolean); const bridges=['Derfor','Samtidig','Desuden','Kort efter','I praksis','If√∏lge skolen']; return bits.map((b,i)=>{ if(/^"/.test(b)) return b; let out=b; if(!/[.!?]$/.test(out)) out=out.charAt(0).toUpperCase()+out.slice(1); if(level>=50){ if(!/\b(er|blev|har|skal|kommer|planl√¶gger|indf√∏rer|udvider)\b/i.test(out)) out += (i%2? ' ‚Äì '+bridges[i%bridges.length].toLowerCase():'') + ' p√• skolen'; } return ensureP(out); }).join(' ');}    
    const L = level; // 0..100
    return parts.map(p=>{ if(p.isQuote){ return p.val.replace(/\‚Äú|\‚Äù/g,'"'); } let t=' '+normalize(p.val)+' '; base.forEach(([r,v])=> t=t.replace(r,' '+v+' ')); if(L>=50){ more.forEach(([r,v])=> t=t.replace(r,v)); t=expand(t); } else if(L>=25){ t=ensureP(t.trim()); } return t; }).join(' ').replace(/\s+/g,' ').trim();
  }

  async function gptSuggest(text, level){
    const key=state.apiKey; if(!key) return null;
    const note = level>=100? 'Tilf√∏j ogs√• en kort underrubrik/manchet (1‚Äì2 linjer) f√∏r br√∏dteksten.' : '';
    const user = `Id√©: ${$('#idea').value}\nVinkel: ${$('#angle').value}\n\nTekst:\n${text}`;
    const sys = `Du er dansk redakt√∏r for en skoleavis. Omskriv til klart, neutralt avisdansk. Behold fakta. Udvid stikord til hele s√¶tninger. \nCitater i "‚Ä¶" m√• kun rettes i stavning/tegn. Niveaunormal: ${level} ud af 100. ${note}`;
    try{
      const res = await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${key}`},body:JSON.stringify({model:'gpt-4o-mini',messages:[{role:'system',content:sys},{role:'user',content:user}],temperature:0.35})});
      if(!res.ok) throw new Error('API-fejl '+res.status);
      const data=await res.json();
      return (data.choices?.[0]?.message?.content||'').trim();
    }catch(e){ console.warn(e); toast('Kunne ikke kontakte GPT ‚Äì bruger lokal hj√¶lp'); return null; }
  }

  async function updateSuggestion(){
    const src = ($('#studentBody').value||'').trim(); if(!src){ aiBox.textContent='(Skriv lidt f√∏rst ‚Ä¶)'; return; }
    const lvl = +slider.value; // 0..100
    let out = await gptSuggest(src, lvl);
    if(!out) out = localLift(src, lvl);
    // Hvis maks, og der er en manchet i f√∏rste afsnit, put den i #sub n√•r vi senere g√•r til S4
    aiBox.textContent = out || '(Intet forslag)';
  }

  $('#regen').addEventListener('click', updateSuggestion);
  slider.addEventListener('change', updateSuggestion);

  $('#adoptAI').addEventListener('click', ()=>{ const t=aiBox.textContent.trim(); if(!t) return toast('Intet forslag endnu'); $('#studentBody').value=t; state.data.studentBody=t; save(); toast('AI‚Äëforslag overtaget'); });
  $('#continueNoAI').addEventListener('click', ()=>{ // flyt elevtekst til S4 felter og videre
    const final = ($('#studentBody').value||'').trim(); if(!final) return toast('Skriv lidt f√∏rst');
    $('#body').value = final; // rubrik/sub udfyldes i S4
    goTo('s4');
  });

  // --- Avisside (som f√∏r) ---
  function makeHeadlineIdeas4(){ const idea=$('#idea').value||'Artikel', angle=$('#angle').value||''; const arr=[ angle, idea+': '+angle, 'Nyt p√• skolen: '+angle, angle+' skaber debat', 'Eleverne om '+(idea||'').toLowerCase() ].filter(Boolean); const ul=$('#headlineIdeas4'); if(!ul) return; ul.innerHTML=''; arr.forEach(t=>{ const li=document.createElement('li'); li.textContent=t; li.onclick=()=>{ $('#headline').value=t; toast('Rubrik valgt'); }; ul.appendChild(li); }); }

  function previewImgs(){ const wrap=$('#imagePreview'); wrap.innerHTML=''; state.images.forEach((img,i)=>{ const d=document.createElement('div'); d.style.cssText='position:relative'; d.innerHTML=`<img src="${img.data}" style="width:120px;height:90px;object-fit:cover;border-radius:8px;border:1px solid var(--line)"><button title="Fjern" style="position:absolute;top:-6px;right:-6px;width:22px;height:22px;border:0;border-radius:50%;background:#e25c47;color:#fff;cursor:pointer">√ó</button>`; d.querySelector('button').onclick=()=>{ state.images.splice(i,1); previewImgs(); }; wrap.appendChild(d); }); }
  $('#imageUpload').addEventListener('change',function(){ Array.from(this.files).forEach(file=>{ if(file.type.startsWith('image/') && file.size<5*1024*1024){ const r=new FileReader(); r.onload=e=>{ state.images.push({name:file.name,data:e.target.result}); previewImgs(); const msg=$('#imgMsg'); msg.style.display='block'; setTimeout(()=> msg.style.display='none',1500); }; r.readAsDataURL(file);} else toast('For stort/ukendt format: '+file.name); }); this.value=''; });

  function updatePageInfo(){ $('#pageInfo').textContent = `Artikler p√• avissiden: ${state.pageArticles.length}`; }
  function renderPageList(){ const ul=$('#pageList'); ul.innerHTML=''; state.pageArticles.forEach((a,i)=>{ const li=document.createElement('li'); li.innerHTML=`<span>${i+1}. ${a.headline||'(uden rubrik)'}${a.sub? ' ‚Äì <em>'+a.sub.substring(0,40)+'</em>':''}</span><button class="btn" data-rm="${i}">Fjern</button>`; ul.appendChild(li); }); ul.querySelectorAll('[data-rm]').forEach(btn=> btn.addEventListener('click', e=>{ const idx=+e.target.getAttribute('data-rm'); state.pageArticles.splice(idx,1); updatePageInfo(); renderPageList(); save(); toast('Fjernet fra avisside'); })); }

  function renderNewspaperHTML(){ const date=new Date().toLocaleDateString('da-DK',{weekday:'long',year:'numeric',month:'long',day:'numeric'}); const blocks=state.pageArticles.map(a=>{ const img=a.image?`<div style="text-align:center;margin:8px 0"><img src="${a.image}" style="max-width:220px;border:1px solid #ccc"></div>`:''; return `<article style="break-inside:avoid;margin-bottom:14px"><h2 style="font-size:18px;margin:0 0 4px">${a.headline||'Uden rubrik'}</h2>${a.sub?`<div style=\"font-style:italic;color:#444;margin-bottom:6px\">${a.sub}</div>`:''}${img}<div style="font-size:13.5px;line-height:1.7;text-align:justify">${(a.body||'').replace(/\n/g,'<br><br>')}</div></article>`; }).join(''); return `<!DOCTYPE html><html><head><meta charset="utf-8"><title>SKOLE AVISEN</title><style>body{margin:12mm auto;max-width:900px;font-family:Georgia,serif} .hdr{border-bottom:3px double #000;padding-bottom:10px;margin-bottom:20px;text-align:center} .hdr h1{margin:0;font-size:28px;letter-spacing:3px} .date{font-size:13px;color:#555;margin-top:4px} .cols{column-count:2;column-gap:18mm}</style></head><body><div class="hdr"><h1>SKOLE AVISEN</h1><div class="date">${date}</div></div><div class="cols">${blocks||'<p>(Ingen artikler endnu)</p>'}</div><div style="text-align:center;font-size:10px;color:#666;margin-top:6px">${state.usedAI? '‚ú® Tekst sprogl√∏ftet af AI p√• baggrund af elevens research':''}</div></body></html>`; }

  function addCurrentToPage(){ const a={ headline:$('#headline').value.trim(), sub:$('#sub').value.trim(), body:$('#body').value.trim(), image:(state.images[0]?.data||null) }; if(!a.headline||!a.body) return toast('Rubrik og br√∏dtekst skal udfyldes'); state.pageArticles.push(a); updatePageInfo(); renderPageList(); save(); toast('Tilf√∏jet: '+a.headline); }
  $('#addToPage').addEventListener('click', addCurrentToPage);
  $('#viewPage').addEventListener('click', ()=>{ if(!state.pageArticles.length) addCurrentToPage(); const html=renderNewspaperHTML(); const w=open('','_blank'); if(w){ w.document.write(html); w.document.close(); } else toast('Pop‚Äëup blev blokeret ‚Äì tillad pop‚Äëups for at se avissiden'); });
  $('#clearPage').addEventListener('click', ()=>{ if(confirm('Ryd hele avissiden?')){ state.pageArticles=[]; updatePageInfo(); renderPageList(); save(); toast('Avisside ryddet'); }});
  $('#print').addEventListener('click', ()=>{ if(!state.pageArticles.length) addCurrentToPage(); const html=renderNewspaperHTML(); const w=open('','_blank'); if(w){ w.document.write(html); w.document.close(); w.focus(); w.print(); } else toast('Pop‚Äëup blev blokeret ‚Äì tillad pop‚Äëups for at printe'); });

  // --- Helpers ---
  function makeHeadlineIdeas4(){ const idea=$('#idea').value||'Artikel', angle=$('#angle').value||''; const arr=[ angle, idea+': '+angle, 'Nyt p√• skolen: '+angle, angle+' skaber debat', 'Eleverne om '+(idea||'').toLowerCase() ].filter(Boolean); const ul=$('#headlineIdeas4'); if(!ul) return; ul.innerHTML=''; arr.forEach(t=>{ const li=document.createElement('li'); li.textContent=t; li.onclick=()=>{ $('#headline').value=t; toast('Rubrik valgt'); }; ul.appendChild(li); }); }

  // Idea help
  $('#ideaHelp').addEventListener('click', ()=>{ const type=$('#type').value; const tips={nyhed:'Nye tiltag ¬∑ √¶ndrede regler ¬∑ events',reportage:'En time i kantinen ¬∑ bag kulisserne',interview:'Ny l√¶rer ¬∑ elev med s√¶rlig hobby',feature:'Skolens historie ¬∑ gr√∏n skole',debat:'Mobiler ¬∑ lektiecaf√© ‚Äì for/imod?', 'ugen-der-gik':'H√∏jdepunkter fra ugen', 'naeste-uge':'Hvad sker der n√¶ste uge?'}; alert('üí° Id√©er til '+type+':\n\n‚Ä¢ '+(tips[type]||'Kig jer omkring og v√¶lg noget n√¶rt.')); });

  load();
})();
</script>
</body>
</html>
